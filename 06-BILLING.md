# 06 - 請求・支払い管理

## Claude Code Implementation Guide - Billing & Payments

> **Note**: 請求はアパート・Оффис 共通の基本機能
> 料金計算方式は物件タイプや機能フラグにより異なる（`04-APARTMENT-FEATURES.md` 参照）

---

## ⚠️ Claude Code への注意点

請求機能は**複数の機能と連携**するため、以下に注意して実装すること。

### 1. 他ドキュメントとの依存関係

```
06-BILLING.md
├── 依存: 01-DATABASE.md（billings, billing_items, payments）
├── 依存: 04-APARTMENT-FEATURES.md（metered 料金計算）
├── 依存: 05-OFFICE-FEATURES.md（lease との連携）
└── 連携: 07-NOTIFICATIONS.md（請求通知、延滞リマインダー）
```

### 2. 料金計算の分岐

料金タイプ（`calculation_type`）によって計算ロジックが異なる：

| タイプ    | 計算元                 | 注意点                                 |
| --------- | ---------------------- | -------------------------------------- |
| `fixed`   | fee_types or unit_fees | シンプル                               |
| `per_sqm` | unit.area_sqm × 単価   | area_sqm が null の場合のハンドリング  |
| `metered` | meter_readings         | 該当月のデータがない場合のハンドリング |
| `custom`  | 手動入力               | 生成時は 0、後で засах                 |

### 3. トランザクション必須の処理

以下の処理は**必ずトランザクション**で実行：

- **請求生成**: billings + billing_items を同時作成
- **支払登録**: payments 追加 + billings.paid_amount 更新 + status 更新
- **請求削除**: billings + billing_items + payments を同時削除

### 4. ステータス更新の自動化

| トリガー             | 更新内容                       |
| -------------------- | ------------------------------ |
| 支払登録時           | paid_amount 計算 → status 判定 |
| 日次バッチ or API 時 | due_date 超過 → overdue        |

### 5. PDF 生成のタイミング

- **遅延生成**: ボタンクリック時に生成（事前生成しない）
- **キャッシュ**: 一度生成したら Storage に Хадгалах、再利用
- **再生成**: 請求 засах 後は古い PDF を削除

### 6. 入居者ポータルの RLS

入居者は**自分の請求のみ**閲覧可能：

```sql
-- RLSポリシー例
CREATE POLICY "Tenants can view own billings"
ON billings FOR SELECT
USING (tenant_id = get_tenant_id());
```

---

## 1. 概要

### 1.1 請求管理の全体像

```
┌─────────────────────────────────────────────────────────────┐
│                      請求フロー                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  料金設定        請求生成         請求送付        支払い     │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐  │
│  │fee_types│───▶│billings │───▶│ 通知    │───▶│payments │  │
│  │unit_fees│    │billing_ │    │ PDF    │    │         │  │
│  │meter_   │    │ items   │    │         │    │         │  │
│  │readings │    │         │    │         │    │         │  │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 関連テーブル（`01-DATABASE.md` 参照）

- `billings` - 請求ヘッダー
- `billing_items` - 請求明細
- `payments` - 支払い記録
- `fee_types` - 料金タイプマスタ
- `unit_fees` - 部屋別料金設定
- `meter_readings` - メーター読み取り

### 1.3 ファイル構造

```
components/features/
└── billing/
    ├── BillingList.tsx
    ├── BillingDetail.tsx
    ├── BillingGenerate.tsx
    ├── BillingItemsTable.tsx
    ├── PaymentForm.tsx
    ├── PaymentHistory.tsx
    └── BillingPdfPreview.tsx
```

---

## 2. 請求一覧

### 2.1 請求一覧画面

**パス**: `/dashboard/billings`

**表示内容**:

```
┌─────────────────────────────────────────────────────────────┐
│ 請求管理                              [請求生成] [エクスポート] │
├─────────────────────────────────────────────────────────────┤
│ フィルター: [物件▼] [月▼] [ステータス▼]        検索:[    ] │
├─────────────────────────────────────────────────────────────┤
│ 請求番号  │ 対象月  │ テナント  │ 部屋  │ 金額     │ 状態   │
│───────────┼─────────┼───────────┼───────┼──────────┼────────│
│ INV-0001  │ 2024-03 │ 山田太郎  │ 101   │ ₮150,000 │ 未払い │
│ INV-0002  │ 2024-03 │ 鈴木花子  │ 102   │ ₮180,000 │ 支払済 │
│ INV-0003  │ 2024-03 │ ABC社    │ 301   │ ₮2,000k │ 一部   │
│ INV-0004  │ 2024-02 │ 山田太郎  │ 101   │ ₮150,000 │ 延滞   │
└─────────────────────────────────────────────────────────────┘
```

**表示項目**:
| 項目 | 説明 |
|------|------|
| 請求番号 | 自動採番（INV-XXXX） |
| 対象月 | billing_month |
| テナント | 入居者/会社名 |
| 部屋 | 物件名 + 部屋番号 |
| 金額 | total_amount |
| 状態 | ステータスバッジ |

**ステータスバッジ色**:
| ステータス | 色 | 表示 |
|-----------|-----|------|
| pending | 黄 | 未払い |
| partial | 青 | 一部支払 |
| paid | 緑 | 支払済 |
| overdue | 赤 | 延滞 |
| cancelled | グレー | キャンセル |

### 2.2 フィルター・ソート

**フィルター**:

- 物件（複数選択可）
- 対象月（範囲指定可）
- ステータス（複数選択可）
- テナント名検索

**ソート**:

- 対象月（デフォルト: 降順）
- 金額
- ステータス
- 発行日

---

## 3. 請求生成

### 3.1 請求生成画面

**パス**: `/dashboard/billings/generate`

**フロー**:

```
┌─────────────────────────────────────────────────────────────┐
│ 請求生成                                                    │
├─────────────────────────────────────────────────────────────┤
│ Step 1: 対象選択                                            │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 対象月: [2024-03 ▼]                                     │ │
│ │ 物件:   [全物件 ▼] または [特定物件選択]                │ │
│ │ 発行日: [2024-03-01]                                    │ │
│ │ 支払期限: [2024-03-15]                                  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                          [次へ: プレビュー] │
├─────────────────────────────────────────────────────────────┤
│ Step 2: プレビュー・確認                                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 生成対象: 25件                                          │ │
│ │                                                         │ │
│ │ □ 101 山田太郎   管理費₮50k + 水道₮12k = ₮62,000      │ │
│ │ □ 102 鈴木花子   管理費₮50k + 水道₮15k = ₮65,000      │ │
│ │ □ 103 田中一郎   管理費₮50k + 水道₮8k  = ₮58,000      │ │
│ │ ...                                                     │ │
│ │                                                         │ │
│ │ [全選択] [全解除]                    合計: ₮1,850,000   │ │
│ └─────────────────────────────────────────────────────────┘ │
│                              [戻る] [請求を生成（25件）]    │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 生成パラメータ

| フィールド    | 型       | 必須 | 説明                  |
| ------------- | -------- | :--: | --------------------- |
| billing_month | month    |  ✅  | 対象年月（YYYY-MM）   |
| property_ids  | string[] |  -   | 対象物件（空=全物件） |
| issue_date    | date     |  ✅  | 発行日                |
| due_date      | date     |  ✅  | 支払期限              |

### 3.3 請求生成ロジック

**対象抽出**:

```
1. 選択した物件の全部屋を取得
2. status = 'occupied' かつ active な契約がある部屋のみ
3. 該当月に既に請求がある部屋は除外
```

**明細計算（部屋ごと）**:

```
1. 部屋に関連する全 fee_types を取得
2. 各 fee_type で金額計算:

   fixed（固定）:
     unit_fees.custom_amount ?? fee_types.default_amount

   per_sqm（Талбай単価）:
     unit.area_sqm × (unit_fees.custom_unit_price ?? fee_types.default_unit_price)

   metered（メーター）:
     該当月の meter_readings.total_amount
     （なければスキップ or 0）

   custom（カスタム）:
     手動入力（生成時は0、後でзасах）

3. billing_items としてХадгалах
4. 合計 → billings.total_amount
```

### 3.4 請求番号の採番ルール

```
フォーマット: INV-{YYYYMM}-{連番4桁}
例: INV-202403-0001

連番は会社ごと・月ごとにリセット
```

---

## 4. 請求詳細

### 4.1 請求詳細画面

**パス**: `/dashboard/billings/[id]`

**表示内容**:

```
┌─────────────────────────────────────────────────────────────┐
│ 請求詳細                    [засах] [PDF] [支払登録] [削除]  │
├─────────────────────────────────────────────────────────────┤
│ ┌─ ヘッダー ──────────────────────────────────────────────┐ │
│ │ 請求番号: INV-202403-0001         ステータス: [未払い]  │ │
│ │ テナント: 山田太郎                                      │ │
│ │ 物件/部屋: サンシャインマンション / 101                 │ │
│ │ 対象月: 2024年3月                                       │ │
│ │ 発行日: 2024-03-01      支払期限: 2024-03-15           │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─ 明細 ──────────────────────────────────────────────────┐ │
│ │ 項目          │ 数量    │ 単価      │ 金額             │ │
│ │───────────────┼─────────┼───────────┼──────────────────│ │
│ │ 管理費        │ 1       │ ₮50,000   │ ₮50,000         │ │
│ │ 水道代        │ 4.8 m³  │ ₮2,500    │ ₮12,000         │ │
│ │ ゴミ代        │ 1       │ ₮10,000   │ ₮10,000         │ │
│ │───────────────┼─────────┼───────────┼──────────────────│ │
│ │                         │ 小計      │ ₮72,000         │ │
│ │                         │ 税        │ ₮0              │ │
│ │                         │ 合計      │ ₮72,000         │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─ 支払状況 ──────────────────────────────────────────────┐ │
│ │ 請求額: ₮72,000                                        │ │
│ │ 支払済: ₮0                                             │ │
│ │ 残高:   ₮72,000                                        │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─ 支払履歴 ──────────────────────────────────────────────┐ │
│ │ （支払記録なし）                                        │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 請求 засах

**засах 可能項目**:

- 発行日、支払期限
- 明細の追加・засах・削除
- 備考

**засах 不可項目**:

- 請求番号
- テナント
- 部屋
- 対象月

### 4.3 請求ステータス遷移

```
┌──────────┐                      ┌──────────┐
│ pending  │─────全額支払────────▶│   paid   │
│ (未払い) │                      │ (支払済) │
└────┬─────┘                      └──────────┘
     │                                  ▲
     │ 一部支払                         │ 残額支払
     ▼                                  │
┌──────────┐────────────────────────────┘
│ partial  │
│(一部支払)│
└────┬─────┘
     │
     │ 期限超過（自動）
     ▼
┌──────────┐
│ overdue  │─────全額支払────────▶ paid
│  (延滞)  │
└──────────┘

※ いつでも cancelled に変更可能
```

**延滞判定（自動）**:

- 毎日のバッチ処理 or API 呼び出し時
- `due_date < 今日` かつ `status = 'pending' or 'partial'` → `overdue`

---

## 5. 支払い管理

### 5.1 支払い登録フォーム

**トリガー**: 請求詳細画面の「支払登録」ボタン

**フォーム項目**:
| フィールド | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| amount | number | ✅ | 支払金額 |
| payment_date | date | ✅ | 支払日 |
| payment_method | select | - | 現金/銀行振込/カード |
| reference_number | string | - | 参照番号（振込番号等） |
| notes | textarea | - | 備考 |

**バリデーション**:

- `amount > 0`
- `amount <= 残高` （超過支払いは警告）

### 5.2 支払い登録ロジック

```
1. payments テーブルにレコード追加
2. billings.paid_amount を更新（累計）
3. ステータス判定:
   paid_amount >= total_amount → 'paid'
   paid_amount > 0 → 'partial'
   else → 変更なし
4. 全額支払時は billings.paid_at を設定
```

### 5.3 支払い履歴

**表示項目**:
| 項目 | 説明 |
|------|------|
| 支払日 | payment_date |
| 金額 | amount |
| 方法 | payment_method |
| 参照番号 | reference_number |
| 記録者 | recorded_by（ユーザー名） |
| 登録日時 | created_at |

---

## 6. PDF 出力

### 6.1 請求書 PDF

**生成トリガー**: 請求詳細の「PDF」ボタン

**PDF 内容**:

```
┌─────────────────────────────────────────────────────────────┐
│                         請 求 書                            │
│                                                             │
│ 請求番号: INV-202403-0001                                   │
│ 発行日: 2024年3月1日                                        │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ 〒XXX-XXXX                                                  │
│ 山田 太郎 様                         ┌─────────────────────┐│
│                                      │ 株式会社サンプル    ││
│                                      │ 〒XXX-XXXX          ││
│                                      │ ウランバートル市... ││
│                                      │ TEL: XX-XXXX-XXXX  ││
│                                      └─────────────────────┘│
│                                                             │
│ 対象: 2024年3月分                                           │
│ 物件: サンシャインマンション 101号室                        │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ 項目              数量        単価          金額            │
│ ─────────────────────────────────────────────────────────── │
│ 管理費            1           ₮50,000       ₮50,000        │
│ 水道代            4.8 m³      ₮2,500        ₮12,000        │
│ ゴミ代            1           ₮10,000       ₮10,000        │
│ ─────────────────────────────────────────────────────────── │
│                               小計          ₮72,000        │
│                               税            ₮0             │
│                               ─────────────────────────    │
│                               合計          ₮72,000        │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ お支払期限: 2024年3月15日                                   │
│                                                             │
│ 振込先:                                                     │
│ ○○銀行 △△支店 普通 1234567                               │
│ 口座名義: カ）サンプル                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 PDF 生成ライブラリ

推奨: `@react-pdf/renderer` または `jspdf`

**Хадгалах 先**: Supabase Storage `billings/{company_id}/{billing_id}.pdf`

---

## 7. 入居者ポータル

### 7.1 請求一覧（入居者側）

**パス**: `/tenant/billings`

**表示内容**:

```
┌─────────────────────────────────────────────────────────────┐
│ 請求一覧                                                    │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 2024年3月分                                   [未払い]  │ │
│ │ 金額: ₮72,000                                          │ │
│ │ 期限: 2024-03-15                                       │ │
│ │                                          [詳細] [PDF]  │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 2024年2月分                                   [支払済]  │ │
│ │ 金額: ₮68,000                                          │ │
│ │ 支払日: 2024-02-10                                     │ │
│ │                                          [詳細] [PDF]  │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 7.2 請求詳細（入居者側）

**パス**: `/tenant/billings/[id]`

**表示内容**:

- 請求ヘッダー情報
- 明細一覧（読み取り専用）
- PDF ダウンロードボタン
- 支払い状況

**アクション**:

- PDF ダウンロード
- （将来）オンライン支払い

---

## 8. 集計・レポート

### 8.1 ダッシュボード用集計

**表示項目**:
| 項目 | 説明 |
|------|------|
| 今月の請求総額 | SUM(total_amount) WHERE billing_month = 今月 |
| 今月の入金額 | SUM(payments.amount) WHERE 今月 |
| 未収金 | SUM(total_amount - paid_amount) WHERE status != 'paid' |
| 延滞件数 | COUNT WHERE status = 'overdue' |

### 8.2 月次レポート

**パス**: `/dashboard/reports/billing`

**集計項目**:

- 物件別請求額
- 物件別入金率
- 料金タイプ別内訳
- 延滞テナント一覧

---

## 9. API エンドポイント

### 9.1 請求 API

| メソッド | パス                          | 説明                   |
| -------- | ----------------------------- | ---------------------- |
| GET      | `/api/billings`               | 一覧（フィルター付き） |
| POST     | `/api/billings/generate`      | 請求生成               |
| GET      | `/api/billings/[id]`          | 詳細                   |
| PUT      | `/api/billings/[id]`          | 更新                   |
| DELETE   | `/api/billings/[id]`          | 削除（キャンセル）     |
| GET      | `/api/billings/[id]/pdf`      | PDF 取得/生成          |
| POST     | `/api/billings/check-overdue` | 延滞チェック実行       |

### 9.2 支払い API

| メソッド | パス                          | 説明     |
| -------- | ----------------------------- | -------- |
| GET      | `/api/billings/[id]/payments` | 支払履歴 |
| POST     | `/api/billings/[id]/payments` | 支払登録 |
| DELETE   | `/api/payments/[id]`          | 支払取消 |

### 9.3 入居者用 API

| メソッド | パス                            | 説明           |
| -------- | ------------------------------- | -------------- |
| GET      | `/api/tenant/billings`          | 自分の請求一覧 |
| GET      | `/api/tenant/billings/[id]`     | 請求詳細       |
| GET      | `/api/tenant/billings/[id]/pdf` | PDF 取得       |

### 9.4 集計 API

| メソッド | パス                           | 説明         |
| -------- | ------------------------------ | ------------ |
| GET      | `/api/reports/billing/summary` | 集計サマリー |
| GET      | `/api/reports/billing/monthly` | 月次レポート |

---

## 10. 入力型定義

```typescript
interface BillingGenerateInput {
  billing_month: string; // required, YYYY-MM
  property_ids?: string[]; // 空 = 全物件
  issue_date: string; // required, YYYY-MM-DD
  due_date: string; // required, YYYY-MM-DD
}

interface BillingGeneratePreview {
  unit_id: string;
  unit_number: string;
  tenant_name: string;
  items: {
    fee_type_id: string;
    fee_name: string;
    quantity: number;
    unit_price: number;
    amount: number;
  }[];
  total_amount: number;
}

interface BillingInput {
  issue_date?: string;
  due_date?: string;
  notes?: string;
}

interface BillingItemInput {
  fee_type_id?: string;
  fee_name: string; // required
  description?: string;
  quantity: number; // required
  unit_price: number; // required
  amount: number; // required
}

interface PaymentInput {
  amount: number; // required, > 0
  payment_date: string; // required, YYYY-MM-DD
  payment_method?: "cash" | "bank_transfer" | "card";
  reference_number?: string;
  notes?: string;
}

interface BillingSummary {
  total_billed: number; // 請求総額
  total_paid: number; // 入金総額
  total_outstanding: number; // 未収金
  overdue_count: number; // 延滞件数
  overdue_amount: number; // 延滞金額
}
```

---

## 11. 定数・設定

```typescript
// 請求ステータス
const BILLING_STATUS = {
  PENDING: "pending", // 未払い
  PARTIAL: "partial", // 一部支払
  PAID: "paid", // 支払済
  OVERDUE: "overdue", // 延滞
  CANCELLED: "cancelled", // キャンセル
} as const;

// 支払方法
const PAYMENT_METHOD = {
  CASH: "cash",
  BANK_TRANSFER: "bank_transfer",
  CARD: "card",
} as const;

// 請求番号フォーマット
const BILLING_NUMBER_FORMAT = "INV-{YYYYMM}-{0000}";

// デフォルト支払期限（発行日から）
const DEFAULT_DUE_DAYS = 15;
```

---

**Document Version**: 1.0  
**Previous**: `05-OFFICE-FEATURES.md`  
**Next**: `07-NOTIFICATIONS.md`
